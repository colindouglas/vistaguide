---
title: "Halifax Listings"
author: "Colin Douglas"
date: "06/04/2020"
output: 
  html_document:
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```
**Last Updated** `r format(Sys.time(), "%b %d, %Y at %H:%M %p")`

```{r Read in data, define regions}

listings_all <- read_csv("data/listings-clean.csv", col_types = cols())

fsa_ns <- read_csv("data/canada_fsa.csv", col_types = cols())  %>%
  filter(`FSA-Province` == 12) %>% # NS
  select(postal = PostalCode, postal_city = `Place Name`, area_type = AreaType) %>%
  mutate(postal = paste(substring(postal, 1, 3), substring(postal, 4, 6)))

peninsula_codes <- c("B3H" = "South End", 
                     "B3J" = "Downtown", 
                     "B3K" = "North End", 
                     "B3L" = "West End")

hrm_places <- c("Halifax", "Dartmouth", "Bedford", "Lower Sackville", "Hammonds Plains", 
                "Beaver Bank", "Timberlea", "Middle Sackville", "Upper Sackville",
                "Lucasville", "Fall River", "Spryfield")

status_colors <- c("For Sale" = "#3288bd", # Blue
                   "Pending" =  "#fdae61", # Yellow
                   "Sold" = "#5aae61", # Green
                   "Cancelled" = "#d53e4f", # Less dark red
                   "Withdrawn" = "#9e0142", # Dark Red
                   "Expired" = "darkgrey")

listings_all <- listings_all %>%
  left_join(fsa_ns, by = "postal") %>%
  mutate(peninsula = peninsula_codes[postal_first],
         loc_bin = factor(
           case_when(
             postal_first %in% names(peninsula_codes) ~ "Halifax Peninsula",
             postal_city == "Halifax" | city == "Halifax" ~ "Halifax, Off Peninsula",
             postal_city == "Dartmouth" | city == "Dartmouth" ~ "Dartmouth",
             postal_city %in% hrm_places | city %in% hrm_places ~ "HRM, Other",
             TRUE ~ "Rest of Province"), 
           levels = c("Halifax Peninsula", "Halifax, Off Peninsula", "Dartmouth", "HRM, Other", "Rest of Province")),
         status = factor(status, levels = names(status_colors)))

listings <- listings_all %>%
  # Keep only the unique rows, because sometimes things get posted more than once
  distinct(mls_no, price, status, .keep_all = TRUE)

```

This dataset contains **`r listings$mls_no %>% unique() %>% length()` unique MLS listings**. The earliest point at which data was collected was `r as_date(min(listings$datetime, na.rm = TRUE))`, and the most recent listing was scraped on `r as_date(max(listings$datetime, na.rm = TRUE))`.

## Price per Square Foot Across the Province
```{r Price per Area on vs. Off, fig.width=8, fig.height=8}

# Clean up the listings, bin each location into something meaningful
hrm_vs_other <- listings %>%
  filter(price < 1E6, between(sqft_mla, 450, 4000), # Nothing too fancy, thanks
         type %in% c("Single Family", "Condominium"))


# Fit each (location bin, type) to a linear model, extract the coefficients and make a pretty box for the graph
sqft_fits <- hrm_vs_other %>%
  group_by(loc_bin, type) %>%
  do(fit = lm(.$price ~ .$sqft_mla)) %>%
  mutate(slope = fit$coefficients[2],
         intercept = fit$coefficients[1],
         pretty = paste0("Base: ", scales::dollar(signif(intercept, 3)),
                         ifelse(is.na(slope), "", paste("\nPer Sq. ft.: ", scales::dollar(signif(slope, 3))))))

hrm_vs_other %>%
  mutate(days_since = as.numeric(ymd(list_date) - ymd("2020-04-01"))) %>%
  filter(days_since >= 0) %>%
  ggplot(aes(x = sqft_mla, y = price)) +
  geom_label(data = sqft_fits, aes(label = pretty),
             x = -Inf, y = Inf, hjust = 0, vjust = 1,
             size = 3) +
  geom_point(aes(color = days_since), na.rm = TRUE, alpha = 0.3) +
  labs(color = "", x = "Square Footage (MLS)", y = "List Price") +
  facet_grid(loc_bin ~ type) +
  scale_color_viridis_c(option = "plasma", 
                        direction = -1,
                        name = "Days Since\n2020-04-01") +
  scale_y_continuous(labels = scales::dollar) +
  geom_smooth(method = "lm", formula = y ~ x, na.rm = TRUE, color = "darkgrey")

```

## Single Family Home Prices

```{r Price per Square Foot Over Time, fig.width = 8, fig.height = 8}

sqft_vs_time <- listings %>%    
  filter(status %in% c("For Sale", "Sold"),
         type == "Single Family",
         (ymd(list_date) > ymd("2020-04-01") | status == "Sold" & ymd(list_date) > ymd("2020-01-01")),
         between(sqft_mla, 450, 4000))


sqft_plot <- sqft_vs_time %>%
  filter(status %in% c("For Sale", "Sold"),
         type == "Single Family") %>%
  ggplot(aes(x = list_date, y = price/sqft_mla)) +
  geom_point(alpha = 0.5, aes(color = substring(postal_first, 1, 2))) +
  facet_grid(loc_bin ~ status, scales = "free") +
  geom_smooth(method = "loess", formula = y~x, color = "darkgrey") +
  labs(x = "List Date", y = "$/Sq. Ft.", color = "") +
  scale_color_viridis_d(option = "plasma", 
                        direction = -1,
                        end = 8/9,
                        name = "")

suppressWarnings(print(sqft_plot))


```

## Where are the Listings?

```{r Listing Location, fig.width = 8, fig.height = 6}

top_20_cities <- listings %>% 
  distinct(mls_no, .keep_all = TRUE) %>%
  filter(!is.na(postal_city), 
         !is.na(type),
         status == "For Sale") %>%
  count(postal_city) %>%
  arrange(-n) %>%
  head(20) %>%
  pull(postal_city)

listings %>%
  filter(postal_city %in% top_20_cities,
         !is.na(type),
         status %in% c("For Sale", "Sold")) %>%
  distinct(mls_no, status, .keep_all = TRUE) %>%
  mutate(postal_city = factor(postal_city, levels = top_20_cities),
         type = ifelse(type == "Single Family", "Single Family", word(type, 1))) %>%
  ggplot(aes(x = postal_city)) +
  geom_bar(aes(fill = type)) +
  facet_wrap(~ status, ncol = 1) +
  scale_fill_viridis_d(option = "plasma", name = "") +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Listing Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

## When are they being listed?

```{r When are the listings, fig.width = 8, fig.height = 4}

listings %>%
  distinct(mls_no, .keep_all = TRUE) %>%
  mutate(type = ifelse(type == "Single Family", "Single Family", word(type, 1))) %>%
  filter(ymd(list_date) > ymd("2020-04-01"), 
         status == "For Sale") %>%
  ggplot(aes(x = ymd(list_date))) +
  geom_bar(aes(fill = type), position = "stack", width = 0.9) +
  scale_fill_viridis_d(option = "plasma", end = 8/9, name = "") +
  xlab("List Date") +
  scale_y_continuous(name = "Count")
```

## Listing By Status Per Day

```{r Status by Day, fig.width = 8, fig.height = 8}

listings_all %>%
  mutate(type = ifelse(type == "Single Family", "Single Family", word(type, 1))) %>%
  filter(ymd(list_date) > ymd("2020-04-01")) %>%
  ggplot(aes(x = as_date(ymd_hms(datetime)))) +
  geom_bar(aes(fill = status), width = 0.9) +
  scale_fill_manual(values = status_colors, name = "", guide = FALSE) +
  facet_grid(status ~ ., scales = "free_y") +
  xlab("Date Scraped") +
  scale_y_continuous(name = "Count")
```

## Postal Codes are Hard

In the dataset, `r (sum(is.na(listings$postal_city)) / nrow(listings) * 100) %>% round(1)`% of the listings have postal codes that don't exist, according to Canada Post. In the dataset, `r (sum(listings$city != listings$postal_city, na.rm = TRUE) / nrow(listings) * 100) %>% round(1)`% of the listings have valid postal codes but the listing address doesn't match the postal code. Here are the disagreements with more than two occurances.

### Postal Codes That Don't Exist

```{r Postal codes that dont exist, rows.print = 10}
listings %>%
  filter(is.na(postal_city)) %>%
  group_by(city) %>%
  summarize(Count = n(),
            `Postal Codes` = str_trunc(paste(postal, collapse = ", "), 70)) %>%
  arrange(-Count) %>%
  rename(`Listed City` = city)
```
### Postal Codes That Describe Somewhere Else


```{r Check for messed up regions, rows.print = 10}
listings %>%
  filter(city != postal_city) %>%
  count(city, postal_city) %>%
  arrange(-n) %>%
  rename(`Listing City` = city,
         `City from Postal Code` = postal_city,
         Count = n) 
```

## Price Changes vs. Status
### Changes in Price
```{r Price Changes}
listings_with_change <- listings %>%
  filter(status != "Pending") %>%
  group_by(pid) %>%
  distinct(status, price, .keep_all = TRUE) %>%
  filter(length(unique(status)) > 1, # Has more than one datapoint
         (length(unique(price)) > 1 | status == "Sold")) %>% # Either it has a "Sold" data point or it has a price change
  arrange(list_date) %>%
  pull(pid)

close_order <- listings %>%
  filter(pid %in% listings_with_change) %>%
  group_by(address) %>%
  summarize(list_date = max(datetime)) %>%
  arrange(list_date) %>%
  pull(address) %>%
  unique()

col_num <- 4
last_listings <- 20 
figure_rows <- last_listings %/% col_num + 1
```

```{r Price Changes Graph, fig.width = 10, fig.height = figure_rows + 2}
listings_all %>%
  filter(pid %in% tail(unique(listings_with_change), last_listings),
         price < 1E6) %>%
  arrange(list_date) %>%
  mutate(address = factor(address, levels = close_order)) %>%
  ggplot(aes(x = as_date(datetime), y = price)) +
  geom_line(aes(group = pid, color = status), lwd = 2, alpha = 0.5) +
  geom_point(aes(color = status), size = 4) +
  scale_color_manual(values = status_colors, name = "") +
  scale_x_date(name = "List Date") +
  facet_wrap(~ address, scales = "free_y", ncol = col_num) +
  ggrepel::geom_text_repel(aes(label = paste0("$", price/1000, "k"))) + 
  scale_y_continuous(name = "Price", breaks = seq(0, 1E6, by = 10000), labels = c()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

### Changes in Status

```{r Everything with Status Change, fig.width = 8, fig.height = 8}
listings_with_change <- listings %>%
  filter(status != "Pending") %>%
  group_by(pid) %>%
  distinct(status, price, .keep_all = TRUE) %>%
  filter(length(unique(status)) > 1) %>%
  pull(pid)

close_order <- listings %>%
  filter(pid %in% listings_with_change) %>%
  group_by(address) %>%
  summarize(list_date = max(datetime)) %>%
  arrange(list_date) %>%
  pull(address) %>%
  unique()

figure_rows <- last_listings %/% col_num + 1

```

```{r Status Change Figure, fig.width = 10, fig.height = figure_rows + 2}
listings_all %>%
  filter(pid %in% tail(unique(listings_with_change), last_listings),
         price < 1E6) %>%
  arrange(list_date) %>%
  mutate(address = factor(address, levels = close_order)) %>%
  ggplot(aes(x = as_date(datetime), y = price)) +
  geom_line(aes(group = pid, color = status), lwd = 2, alpha = 0.5) +
  geom_point(aes(color = status), size = 4) +
  scale_color_manual(values = status_colors, name = "") +
  scale_x_date(name = "List Date") +
  facet_wrap(~ address, scales = "free_y", ncol = col_num) +
  ggrepel::geom_text_repel(aes(label = paste0("$", price/1000, "k"))) + 
  scale_y_continuous(name = "Price", breaks = seq(0, 1E6, by = 10000), labels = c()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

change_plot <- listings_all %>%
  group_by(pid) %>%
  filter(n() > 1) %>%
  arrange(datetime) %>%
  mutate(price_change = (price - lag(price))/lag(price)) %>%
  filter(!(is.na(price_change)),
         abs(price_change) < 0.5)
```

## Price Changes Over Time
### Everything
```{r price changes over time}
price_change_fig <- change_plot %>%
  ggplot(aes(x = datetime, y = price_change)) +
  geom_jitter(data = filter(change_plot, price_change != 0), aes(color = status), width = 60*60*24, height = 0, alpha = 0.3) +
  geom_smooth(data = filter(change_plot, status %in% c("Sold", "For Sale", "Pending")), 
              formula = y ~ x,
              method = "loess", 
              aes(color = status), 
              level = 0,
              lwd = 0.5) +
  scale_color_manual(values = status_colors, name = "") +
  labs(x = "Change Date") +
  scale_y_continuous(name = "Price", labels = scales::percent, minor_breaks = seq(-1, 1, by = .05)) +
  geom_hline(yintercept = 0, lty = 2, lwd = 0.25) +
  scale_alpha_continuous(guide = FALSE)

price_change_fig
```

### Last Two Weeks
```{r}
price_change_fig +
  scale_x_datetime(limits = c(now() - weeks(2), now()))
```

## Assessment vs. Sale Price

```{r Assessment vs. Sale Price, fig.width = 8, fig.height = 5}

listings_all %>%
  filter(status == "Sold",
         assessment < 1E6,
         assessment_year == "2020") %>%
  ggplot(aes(x = assessment, y = price)) +
  geom_point(aes(color = loc_bin), na.rm = TRUE) +
  scale_color_viridis_d(option = "plasma", name = "", end = 7/9) +
  scale_x_continuous(name = "Assessment (2020)", labels = scales::dollar) +
  scale_y_continuous(name = "Sale Price", labels = scales::dollar) +
  geom_abline(slope = c(1, 2, 3, 4, 5), 
              alpha = 1/c(1, 2, 3, 4, 5),
              lty = c(2, 3, 3, 3, 3))
```

### More than Double Assessment
```{r Double assessment}
listings_all %>% 
  distinct(pid, .keep_all = TRUE) %>%
  filter(status == "Sold",
         assessment > 0,
         (price - assessment) / assessment > 2) %>%
  mutate(ratio = round(price / assessment, 1)) %>%
  select(street, city, postal, assessment, price, ratio, url) %>%
  arrange(-price)
```

### Predicting Sale Price from Assessment
```{r Sale Price Prediction}
listings_all %>%
  filter(status == "Sold", type == "Single Family") %>%
  lm(price ~ assessment, data = .) %>%
  summary()
```