---
title: "Halifax Listings"
author: "Colin Douglas"
date: "6-Apr-2020"
output: 
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(kableExtra)
source("setup.R")
```
**Last Updated** `r format(Sys.time(), "%b %d, %Y at %H:%M %p")`

```{r Read in data, define regions}

listings_all <- read_csv("data/listings-clean.csv", col_types = cols())

listings <- listings_all %>%
  filter(!is.na(type)) %>%
  arrange(datetime) %>%
  # Keep only the unique rows, because sometimes things get posted more than once
  distinct(mls_no, pid, price, status, .keep_all = TRUE) %>%
  mutate(status = factor(status, levels = names(status_colors)))

```
# Summary
This dataset contains **`r nrow(listings_all)` data points** on **`r listings$mls_no %>% unique() %>% length()` unique MLS listings**. The last update was performed on **`r as_date(max(listings$datetime, na.rm = TRUE))`**, and scraped **`r listings %>% filter(as_date(datetime) == as_date(max(datetime))) %>% pull(pid) %>% unique() %>% length()`** different listing pages.

# Volume
## Where are the Listings?

```{r Listing Location, fig.width = 8, fig.height = 6}

top_20_cities <- listings %>% 
  distinct(mls_no, .keep_all = TRUE) %>%
  filter(!is.na(postal_city), 
         !is.na(type),
         status == "For Sale") %>%
  count(postal_city) %>%
  arrange(-n) %>%
  head(20) %>%
  pull(postal_city)

listings %>%
  filter(postal_city %in% top_20_cities,
         !is.na(type),
         status %in% c("For Sale", "Sold")) %>%
  distinct(mls_no, status, .keep_all = TRUE) %>%
  mutate(postal_city = factor(postal_city, levels = top_20_cities),
         type = ifelse(type == "Single Family", "Single Family", word(type, 1))) %>%
  ggplot(aes(x = postal_city)) +
  geom_bar(aes(fill = type)) +
  facet_wrap(~ status, ncol = 1) +
  scale_fill_viridis_d(option = "plasma", name = "") +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Listing Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

## When are they Being Listed

```{r When are the listings, fig.width = 8, fig.height = 4}

listings %>%
  distinct(mls_no, .keep_all = TRUE) %>%
  mutate(type = ifelse(type == "Single Family", "Single Family", word(type, 1))) %>%
  filter(ymd(list_date) > ymd("2020-04-01"), 
         status == "For Sale") %>%
  ggplot(aes(x = ymd(list_date))) +
  geom_bar(aes(fill = type), position = "stack", width = 0.9) +
  scale_fill_viridis_d(option = "plasma", end = 8/9, name = "") +
  xlab("List Date") +
  scale_y_continuous(name = "Count")
```

## Listing By Status Per Day

```{r Status by Day, fig.width = 8, fig.height = 8}

listings %>%
  mutate(type = ifelse(type == "Single Family", "Single Family", word(type, 1))) %>%
  filter(!is.na(status)) %>%
  ggplot(aes(x = as_date(ymd_hms(datetime)))) +
  geom_bar(aes(fill = status), width = 0.9) +
  scale_fill_manual(values = status_colors, name = "", guide = FALSE) +
  facet_grid(status ~ ., scales = "free_y") +
  xlab("Date Scraped") +
  scale_y_continuous(name = "Count")
```

## Changes in Inventory
This figure shows the net change in inventory in a given day. It is calculated as new listings with a status of "For Sale" minus the sum of new listings with the statuses "Sold", "Expired", "Withdrawn", and "Cancelled". Listings with a status of "Pending" are ignored.
```{r Balance in Listings}
listing_type <- c("For Sale" = "enter", 
                  "Sold" = "exit", 
                  "Pending" = NA, 
                  "Withdrawn" = "exit", 
                  "Cancelled" = "exit", 
                  "Expired" = "exit")

volume_changes <- listings %>%
  mutate(status_type = listing_type[status]) %>%
  filter(!is.na(status_type)) %>%
  group_by(date = as_date(datetime), status_type) %>%
  summarize(N = n()) %>%
  pivot_wider(id_cols = date, names_from = "status_type", values_from = "N") %>%
  mutate(net_change = enter - exit)

volume_changes %>%
  ggplot(aes(x = date, y = net_change)) +
  geom_col(aes(fill = net_change > 0)) +
  scale_fill_manual(values = unname(status_colors[c(3, 1)]), guide = FALSE) +
  geom_text(aes(y = net_change + 2 * sign(net_change), label = net_change)) +
  labs(x = "Date", y = "Net Change in Active Listings")
```


# Pricing
## Per Square Foot in Different Regions
```{r Price per Area on vs. Off, fig.width=8, fig.height=8}

# Clean up the listings, bin each location into something meaningful
hrm_vs_other <- listings %>%
  filter(price < 1E6, between(sqft_mla, 450, 4000), # Nothing too fancy, thanks
         type %in% c("Single Family", "Condominium"))


# Fit each (location bin, type) to a linear model, extract the coefficients and make a pretty box for the graph
sqft_fits <- hrm_vs_other %>%
  group_by(loc_bin, type) %>%
  do(fit = lm(.$price ~ .$sqft_mla)) %>%
  mutate(slope = fit$coefficients[2],
         intercept = fit$coefficients[1],
         pretty = paste0("Base: ", scales::dollar(signif(intercept, 3)),
                         ifelse(is.na(slope), "", paste("\nPer Sq. ft.: ", scales::dollar(signif(slope, 3))))))

hrm_vs_other %>%
  mutate(days_since = as.numeric(ymd(list_date) - ymd("2020-04-01"))) %>%
  filter(days_since >= 0) %>%
  ggplot(aes(x = sqft_mla, y = price)) +
  geom_label(data = sqft_fits, aes(label = pretty),
             x = -Inf, y = Inf, hjust = 0, vjust = 1,
             size = 3) +
  geom_point(aes(color = days_since), na.rm = TRUE, alpha = 0.3) +
  labs(color = "", x = "Square Footage (MLS)", y = "List Price") +
  facet_grid(loc_bin ~ type) +
  scale_color_viridis_c(option = "plasma", 
                        direction = -1,
                        name = "Days Since\n2020-04-01") +
  scale_y_continuous(labels = scales::dollar) +
  geom_smooth(method = "lm", formula = y ~ x, na.rm = TRUE, color = "darkgrey")

```

## Price Trends by Listing Type

```{r Price per Square Foot Over Time, fig.width = 8, fig.height = 8}

sqft_vs_time <- listings %>%    
  filter(status %in% c("For Sale", "Sold"),
         between(sqft_mla, 450, 4000),
         !is.na(type))

svt_fit <- sqft_vs_time %>%
  group_by(status, type, loc_bin) %>%
  filter(n() > 10)


sqft_plot <- svt_fit  %>% 
  ggplot(aes(x = datetime, y = price/sqft_mla)) +
  geom_point(alpha = 0.2, aes(color = type)) +
  facet_grid(loc_bin ~ status, scales = "free_y") +
  geom_smooth(data = svt_fit, method = "loess", formula = y~x, aes(color = type), level = 0.01, lwd = 0.5) +
  labs(x = "List Date", y = "$/Sq. Ft.", color = "")

suppressWarnings(print(sqft_plot))

```


## List Price vs. Sale Price and Re-List Price
```{r price changes over time, fig.width = 8, fig.height = 4}

change_plot <- listings %>%
  group_by(pid) %>%
  filter(n() > 1) %>%
  arrange(datetime) %>%
  mutate(price_change = (price - lag(price))/lag(price)) %>%
  filter(!(is.na(price_change)),
         abs(price_change) < 0.5)

change_labels <- change_plot %>%
  group_by(status) %>%
  filter(datetime > now() - weeks(1),
         status %in% c("Sold", "For Sale")) %>%
  summarize(mean_change = mean(price_change))


change_plot %>%
  ggplot(aes(x = datetime, y = price_change)) +
  geom_jitter(data = filter(change_plot, price_change != 0), aes(color = status), width = 60*60*24*0.5, height = 0, alpha = 0.3) +
  geom_smooth(data = filter(change_plot, status %in% c("Sold", "For Sale")), 
              formula = y ~ x,
              method = "loess", 
              aes(color = status), 
              level = 0,
              lwd = 0.5) +
  scale_color_manual(values = status_colors, name = "") +
  labs(x = "Posting Date") +
  scale_y_continuous(name = "Price Change Since Last Event", labels = scales::percent, minor_breaks = seq(-1, 1, by = .05)) +
  geom_hline(yintercept = 0, lty = 2, lwd = 0.25) +
  scale_alpha_continuous(guide = FALSE) +
  #facet_grid(loc_bin ~ ., scales = "free_y") + 
  scale_x_datetime(limits = c(as_datetime(NA), now() + days(1))) +
  ggrepel::geom_label_repel(data = change_labels, x = now(), 
                            aes(y = mean_change, color = status, label = scales::percent(mean_change, accuracy = 0.01)), 
                            hjust = 0, direction = 'y')

```

## Assessment vs. Sale Price

```{r Assessment vs. Sale Price, fig.width = 8, fig.height = 5}

listings %>%
  filter(status == "Sold",
         assessment < 1E6,
         assessment_year == "2020") %>%
  ggplot(aes(x = assessment, y = price)) +
  geom_point(aes(color = loc_bin), na.rm = TRUE) +
  scale_color_viridis_d(option = "plasma", name = "", end = 7/9) +
  scale_x_continuous(name = "Assessment (2020)", labels = scales::dollar) +
  scale_y_continuous(name = "Sale Price", labels = scales::dollar) +
  geom_abline(slope = c(1, 2, 3, 4, 5), 
              alpha = 1/c(1, 2, 3, 4, 5),
              lty = c(2, 3, 3, 3, 3))
```

# Postal Codes

In the dataset, `r (sum(is.na(listings$postal_city)) / nrow(listings) * 100) %>% round(1)`% of the listings have postal codes that don't exist, according to Canada Post. In the dataset, `r (sum(listings$city != listings$postal_city, na.rm = TRUE) / nrow(listings) * 100) %>% round(1)`% of the listings have valid postal codes but the listing address doesn't match the postal code. Here are the disagreements with more than two occurances.

## Postal Codes That Don't Exist

```{r Postal codes that dont exist, rows.print = 10}
listings %>%
  filter(is.na(postal_city)) %>%
  group_by(city) %>%
  summarize(Count = n(),
            `Postal Codes` = str_trunc(paste(postal, collapse = ", "), 70)) %>%
  arrange(-Count) %>%
  rename(`Listed City` = city)
```
## Postal Codes That Describe Somewhere Else


```{r Check for messed up regions, rows.print = 10}
listings %>%
  filter(city != postal_city) %>%
  count(city, postal_city) %>%
  arrange(-n) %>%
  rename(`Listing City` = city,
         `City from Postal Code` = postal_city,
         Count = n) 
```
# Listing-Level Analysis
## Changes in Price

These are the 20 most recently-listed addresses that have a change and have "Sold" somewhere in their recent history.
```{r Price Changes}
listings_with_change <- listings %>%
  filter(status != "Pending") %>%
  group_by(pid) %>%
  distinct(status, price, .keep_all = TRUE) %>%
  filter(length(unique(status)) > 1, # Has more than one datapoint
         (length(unique(price)) > 1 | status == "Sold")) %>% # Either it has a "Sold" data point or it has a price change
  arrange(list_date) %>%
  pull(pid)

close_order <- listings %>%
  filter(pid %in% listings_with_change) %>%
  group_by(address) %>%
  summarize(list_date = max(datetime)) %>%
  arrange(list_date) %>%
  pull(address) %>%
  unique()

col_num <- 4
last_listings <- 20 
figure_rows <- last_listings %/% col_num + 1
```

```{r Price Changes Graph, fig.width = 10, fig.height = figure_rows + 2}

pid_to_address <- listings_all %>%
  group_by(pid) %>%
  summarize(address = head(address, 1))

pid_labeller <- pid_to_address$address
names(pid_labeller) <- as.character(pid_to_address$pid)

listings_all %>%
  filter(pid %in% tail(unique(listings_with_change), last_listings),
         price < 1E6) %>%
  arrange(list_date) %>%
  mutate(address = factor(address, levels = close_order)) %>%
  ggplot(aes(x = as_date(datetime), y = price)) +
  geom_line(aes(group = pid, color = status), lwd = 2, alpha = 0.5) +
  geom_point(aes(color = status), size = 4) +
  scale_color_manual(values = status_colors, name = "") +
  scale_x_date(name = "List Date") +
  facet_wrap(~ pid, scales = "free_y", ncol = col_num, labeller = labeller(pid = pid_labeller)) +
  ggrepel::geom_text_repel(aes(label = paste0("$", price/1000, "k"))) + 
  scale_y_continuous(name = "Price", breaks = seq(0, 1E6, by = 10000), labels = c()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

## Changes in Status

These are the 20 most recently-listed addresses that have a change. They don't necessarily have a "sold" entry in their history.

```{r Everything with Status Change, fig.width = 8, fig.height = 8}
listings_with_change <- listings_all %>%
  filter(status != "Pending") %>%
  group_by(pid) %>%
  distinct(status, price, .keep_all = TRUE) %>%
  filter(length(unique(status)) > 1) %>%
  pull(pid)

close_order <- listings_all %>%
  filter(pid %in% listings_with_change) %>%
  group_by(address) %>%
  summarize(list_date = max(datetime)) %>%
  arrange(list_date) %>%
  pull(address) %>%
  unique()

figure_rows <- last_listings %/% col_num + 1

```

```{r Status Change Figure, fig.width = 10, fig.height = figure_rows + 2}
listings_all %>%
  filter(pid %in% tail(unique(listings_with_change), last_listings),
         price < 1E6) %>%
  arrange(list_date) %>%
  mutate(address = factor(address, levels = close_order)) %>%
  ggplot(aes(x = as_date(datetime), y = price)) +
  geom_line(aes(group = pid, color = status), lwd = 2, alpha = 0.5) +
  geom_point(aes(color = status), size = 4) +
  scale_color_manual(values = status_colors, name = "") +
  scale_x_date(name = "List Date") +
  facet_wrap(~ pid, scales = "free_y", ncol = col_num, labeller = labeller(pid = pid_labeller)) +
  ggrepel::geom_text_repel(aes(label = paste0("$", price/1000, "k"))) + 
  scale_y_continuous(name = "Price", breaks = seq(0, 1E6, by = 10000), labels = c()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```

## Listings on Gladstone

```{r Listings at on Gladstone}
listings_all %>%
  filter(grepl("Gladstone", address)) %>%
  mutate(date = as_date(datetime)) %>%
  select(date, address=street, unit, price, condo_fee, url) %>%
  arrange(date)

```

# Sale Price Model

```{r, Model setup, include=FALSE}
source("pricing-model.R")
rows_print <- 15
```
The current 'complex model' is **`r paste(deparse(complex_form, width.cutoff = 500), collapse="")`**.
```{r, model figs, fig.width = 12, fig.height = 5}
model_figs
```

## Asking Too Much
Top `r rows_print` overvalued properties from the last two weeks
```{r overvalued properties, rows.print = 10}

print_listing_table <- function(df) {
  df %>%
  filter(list_date > today() - days(14)) %>%
  head(rows_print) %>%
  mutate(address_link = cell_spec(address, "html", link = url),
         value_score = round(xsv_z * 100),
         complex_prd = scales::dollar(complex_prd),
         price =  scales::dollar(price)) %>%
    select(Address = address_link, 
           Location = loc_bin,
         `Predicted Price` = complex_prd,
         `Listing Price` = price,
         `Sq. Ft` = sqft_tla,
         `Value Score` = value_score) %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("hover", "condensed"))
  
}

test_set %>%
  arrange(xsv_z) %>%
  print_listing_table(.)
```

## MAD DEALZ
Top `r rows_print` undervalued properties from the last two weeks
```{r undervalued properties, rows.print = 10}

test_set %>%
  arrange(-xsv_z) %>%
  print_listing_table(.)
```